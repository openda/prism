<template>
  <div class="container">
    <Row :gutter="16">
      <Col span="8">
      <Form :label-width="100">
        <Form-item label="数据库配置">
          <Select v-on:on-change="handleDB" placeholder="请选择数据库配置">
            <Option v-for="item in databases" :value="item.no" >{{ item.no }}（{{ item.type }}）</Option>
          </Select>
        </Form-item>
        <Form-item v-if="dbReady" label="数据库">
          <Select  v-model="db_name" v-on:on-change="handleDBName" placeholder="请选择数据库">
            <Option v-for="db in dbs" :value="db" >{{ db }}</Option>
          </Select>
        </Form-item>
        <Form-item v-if="tableReady" label="数据表">
          <Select  v-model="table_name" v-on:on-change="handleTableName" placeholder="请选择数据表">
            <Option v-for="table in tableList" :value="table" >{{ table }}</Option>
          </Select>
        </Form-item>
        <Form-item v-if="colReady" label="数据列">
          <Checkbox-group v-model="checkGroup" @on-change="checkChange">
            <Checkbox v-for="col in colList" :label="col.field"></Checkbox>
          </Checkbox-group>
        </Form-item>
      </Form>
      </Col>
      <Col span="16">
      </Col>
    </Row>
  </div>
</template>
<script>
  import axios from 'axios'
//  import qs from 'qs'
  import inter from '../utils/interface'

  export default {
    data: () => {
      return {
        databases: [],
        db_id: null,
        db_name: null,
        table_name: null,
        dbReady: false,
        tableReady: false,
        colReady: false,
        dbs: [],
        tableList: [],
        indeterminate: true,
        checkGroup: [],
        colList: []
      }
    },
    methods: {
      getCol: function (type) {
        axios.get(inter.userdb, {
          params: {
            db_link_id: this.db_id,
            db_name: this.db_name,
            table_name: this.table_name
          }
        }).then((res) => {
          let data = res.data.data
          switch (type) {
            case 'db_name':
              if (!data) {
                console.log(data)
              } else {
                for (let index = 0; index < data.length; index++) {
                  this.dbs.push(data[index].db_name)
                }
                this.dbReady = true
              }
              break
            case 'db_table':
              if (!data) {
                console.log(data)
              } else {
                for (let index = 0; index < data.length; index++) {
                  let tables = data[index].tables
                  for (let count = 0; count < tables.length; count++) {
                    this.tableList.push(tables[count].table_name)
                  }
                }
                this.tableReady = true
              }
              break
            case 'db_struct':
              if (!data) {
                console.log(data)
              } else {
                for (let index = 0; index < data.length; index++) {
                  let table = data[index].tables
                  let tableStructures = table.table_structure
                  for (let i = 0; i < tableStructures.length; i++) {
                    this.colList.push(tableStructures[i])
                  }
                }
                this.colReady = true
              }
              break
          }
        })
      },
      handleDB: function (selected) {
        this.db_id = selected
        this.dbReady = false
        this.tableReady = false
        this.colReady = false
        this.dbs = []
        this.getCol('db_name')
      },
      handleDBName: function (selected) {
        this.db_name = selected
        this.getCol('db_table')
      },
      handleTableName: function (selected) {
        this.table_name = selected
        this.getCol('db_struct')
      },
      checkChange (data) {
        console.log(this.checkGroup)
      }
    },
    mounted: function () {
      axios.get(inter.dblink)
        .then((res) => {
          let data = res.data.data
          var array = []
          for (var index = 0; index < data.length; index++) {
            array.push({
              index: index + 1,
              no: data[index].db_id,
              type: data[index].db_type
            })
          }
          this.databases = array
        })
    }
  }
</script>
<style scoped>
  .container {
    padding: 1em 0.5em;
  }
  h1 {
    text-align: center;
    margin-bottom: 0.5em;
  }
  span.err{
    color: red;
  }
</style>
